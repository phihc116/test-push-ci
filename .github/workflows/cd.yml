name: Build and Push to Registry
run-name: >
  Deployment â†’ Env: ${{ github.event.inputs.environment }},
  Level: ${{ github.event.inputs.update_level }},
  Services: 
  ${{ github.event.inputs.deploy_service_a == 'true' && 'service A ' || '' }}
  ${{ github.event.inputs.deploy_service_b == 'true' && 'service B' || '' }}
on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, staging, prod]
      update_level:
        type: choice
        options: [major, minor, patch]
      deploy_service_a:
        type: boolean
        default: true
      deploy_service_b:
        type: boolean
        default: true
permissions:
  contents: write

jobs:
  service-a:
    if: ${{ github.event.inputs.deploy_service_a == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4      
      - uses: ./.github/actions/deploy
        with:
          service: service-a
          environment: ${{ github.event.inputs.environment }}
          update_level: ${{ github.event.inputs.update_level }}
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          lark_webhook: ${{ secrets.LARK_WEBHOOK }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  service-b:
    if: ${{ github.event.inputs.deploy_service_b == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4          
      - uses: ./.github/actions/deploy
        with:
          service: service-b
          environment: ${{ github.event.inputs.environment }}
          update_level: ${{ github.event.inputs.update_level }}
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          lark_webhook: ${{ secrets.LARK_WEBHOOK }}
          github_token: ${{ secrets.GITHUB_TOKEN }}          
