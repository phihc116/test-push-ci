name: Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options:
          - dev
          - staging
          - prod
      update_level:
        type: choice
        options:
          - major
          - minor
          - patch
      deploy_service_a:
        type: boolean
        default: true
      deploy_service_b:
        type: boolean
        default: true

jobs:
  service-a:
    if: ${{ github.event.inputs.deploy_service_a == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Service A
        run: |
          echo "Deploying Service A"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Update level: ${{ github.event.inputs.update_level }}"
      - name: Checkout repo
        uses: actions/checkout@v4          
      - name: Bump tag
        id: bump
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const bumpTag = require('./.github/scripts/bump-tag.js');
            const result = await bumpTag({
              github,
              context,
              service: "service_a",
              env: "${{ github.event.inputs.environment }}",
              updateLevel: "${{ github.event.inputs.update_level }}"
            });
            core.setOutput("latestTag", result.latestTag);
            core.setOutput("newTag", result.newTag);    

  service-b:
    if: ${{ github.event.inputs.deploy_service_b == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Service B
        run: |
          echo "Deploying Service B"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Update level: ${{ github.event.inputs.update_level }}"
      - name: Checkout repo
        uses: actions/checkout@v4          
      - name: Bump tag
        id: bump
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const bumpTag = require('./.github/scripts/bump-tag.js');
            console.log(bumpTag);
            const result = await bumpTag({
              github,
              context,
              service: "service_b",
              env: "${{ github.event.inputs.environment }}",
              updateLevel: "${{ github.event.inputs.update_level }}"
            });
            core.setOutput("latestTag", result.latestTag);
            core.setOutput("newTag", result.newTag);         
